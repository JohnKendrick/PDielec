# CsI Data Preparation

## Get structure
Download the CsI structure from the open crystallographic database

    cp ~/Downloads/2106199.cif .

## Generate initial Vasp files

	cif2cell 2106199.cif -p vasp --setup-all --vasp-format=5


## Check the INCAR file

To do an optimisation of the cell and atomic positions my INCAR looks like this; 


    # Generated by cif2cell 1.2.10.
    ENCUT = 400.0
    #NBANDS = 36
    IBRION = 1   ! Optimisation method 1=RMM-DIIS 2=CG
    POTIM = 0.2  ! Initial maximum step length
    ISIF = 3     ! 3=optimise cell and ions, 2 = optimise ions
    NSW = 50     ! Number of geometry opt steps
    NELMIN = 4   ! Minimum number of electronic opt steps
    LPLANE = .TRUE.  ! Optimised for a 4 core machine
    NPAR = 8         ! 64 Core machine
    PREC = Accurate
    LREAL = Auto
    ISMEAR = -5       ! Smearing method 0=Gaussian, -5=tetrahedron
    SIGMA = 0.05
    LMAXMIX = 4
    LASPH = .TRUE.



## Check the KPOINTS file

	Generated by cif2cell 1.2.10. k-space resolution ~0.2/A
	 0
	Gamma
	8 8 8
	0 0 0



## Submit job for cell optimisation
	vasprun cellopt 24 4
Cell optimisation achieved in 9 iterations.  The bottom of the log file looks like this;

	   9 F= -.10687960E+02 E0= -.10687960E+02  d E =-.421982E-03
	 BRION: g(F)=  0.970E-62 g(S)=  0.646E-05 retain N=  1 mean eig= 6.35
	 eig:   6.348
	 reached required accuracy - stopping structural energy minimisation
	 writing wavefunctions
	End at Tue 5 Feb 10:31:57 GMT 2019

## Submit job for fixed-cell optimisation (tighter convergence of atom positions)
	vasp_fixedcell . 24 1
In this case there was no further optimisation.  I think this is because symmetry dictates the position of the atoms in the unit cell.  In general though this step is necessary.

## Submit job for dielectric calculation
	cd FixedCell
	vasp_dielectric . 24 1

## Examine output of dielectric calculation
	cd Dielectric
	tail *.log

There can be problems with the convergence of the calculation of the polarisation in a field.  This can be because the system is metallic or has a small band gap resulting in a high polarisability.  Usually though for organic crystals there is not a problem.  After the calculation of the polarisation the calculation proceeds to solve the DFPT equations for each degree of freedom in the system.  
Once the calculation has finished you can look at the frequencies with;

	grep 'f..=' OUTCAR

	   1 f  =    2.025542 THz    12.726854 2PiTHz   67.564796 cm-1     8.376970 meV
	   2 f  =    2.025542 THz    12.726854 2PiTHz   67.564796 cm-1     8.376970 meV
	   3 f  =    1.679141 THz    10.550354 2PiTHz   56.010111 cm-1     6.944371 meV
	   4 f  =    1.675257 THz    10.525949 2PiTHz   55.880553 cm-1     6.928308 meV
	   5 f  =    1.675257 THz    10.525949 2PiTHz   55.880553 cm-1     6.928308 meV
	   6 f  =    1.285918 THz     8.079660 2PiTHz   42.893601 cm-1     5.318131 meV
	   7 f  =    1.285918 THz     8.079660 2PiTHz   42.893601 cm-1     5.318131 meV
	   8 f  =    1.082721 THz     6.802938 2PiTHz   36.115691 cm-1     4.477777 meV
	   9 f  =    0.995763 THz     6.256565 2PiTHz   33.215087 cm-1     4.118147 meV
	  10 f/i=    0.000189 THz     0.001190 2PiTHz    0.006315 cm-1     0.000783 meV
	  11 f/i=    0.013944 THz     0.087614 2PiTHz    0.465129 cm-1     0.057669 meV
	  12 f/i=    0.013944 THz     0.087614 2PiTHz    0.465129 cm-1     0.057669 meV

Things to look for are the three very small frequencies (10,11 &12) in this case.  These can be as large as 10cm-1 before you really need to worry about them.  If there are 4 such frequencies then one of them will probably be a true imaginary mode that indicates a lattice instability.  Possible approaches to resolving this would be to allow VASP to do the calculations again but with no symmetry.  In this case it may be necessary to move atoms slightly away from their symmetric positions before optimisation.  In this case there is no problem.

## PHONOPY CALCULATIONS

To start preparing the phonopy job we need the INCAR, CONTCAR, POTCAR and KPOINTS file from the FixedCell/ directory.  Note that we rename CONTCAR to POSCAR.  CONTCAR contains the optimised structure and we want to use it to do the PHONOPY calculation.  To speed up the calculation it is useful to have the WAVECAR, CHG and CHGCAR files available too.

	cd FixedCell
	mkdir Phonopy
	cp INCAR KPOINTS POTCAR Phonopy/
	cp WAVECAR CHG CHGCAR Phonopy/
	cp CONTCAR Phonopy/POSCAR 
	cd Phonopy

### INCAR.born
I create INCAR.born by copying the INCAR file to INCAR.born.  This INCAR file must have the same settings for cutoffs and any van der waals settings must be the same.  Similarly smearing needs to be kept the same.  What is important is that "IBRION = " must be removed along with the LPLANE, POTIM, NFREE, NSW and ISIF directives.  Any parallelization directive should be taken out too.  The file must include LCALCEPS, LWAVE and LCHARGE as shown below;

	ENCUT = 400.0
	LASPH = .TRUE.
	LMAXMIX = 4
	ISTART =  1
	ICHARG = 0
	LPLANE = .TRUE.  ! Optimised for a 4 core machine
	PREC   = Accurate
	LREAL  = .FALSE.
	ISMEAR = -5      ! Smearing method 0=Gaussian, -5=tetrahedron (needs gamma and >2 kpoints)
	SIGMA  = 0.05    ! Width of smearing 
	EDIFF  = 1.0E-8
	EDIFFG = -5.0E-4
	LCALCEPS = .TRUE.
	LWAVE = .FALSE.
	LCHARGE = .FALSE.

The purpose of LWAVE and LCHARGE is to tell VASP not to write to the WAVECAR and CHG, CHGCAR files.  We will be using links to allow each calculation to start up with a reasonable guess of the wavefunction and charges.  Rather than copy these huge files, we will just have a link to a file in the top Phonopy/ directory.

### INCAR.supercell
I create INCAR.supercell by copying the INCAR file to INCAR.supercell.  This file will be used as the INCAR for each of the perturbed geometry calculations. The INCAR files used by Phonopy have to be taken from the preceding optimisation.  The cutoffs and any van der waals settings must be the same.  Similarly smearing needs to be kept the same.  What is important is that "IBRION = -1" must be present and the NSW directive must be removed.
Here is my INCAR.supercell file;

	ENCUT = 400.0
	LASPH = .TRUE.
	LMAXMIX = 4
	ISTART =  1
	ICHARG = 0
	IBRION = -1      ! Optimisation method 1=RMM-DIIS 2=CG -1=no optimisation
	POTIM  = 0.4     ! The step size along the steepest descent direction
	ISIF   = 2       ! 3=optimise cell and ions, 2=optimise ions
	NELMIN = 4       ! The minimum number of electronic optimisation steps
	LPLANE = .TRUE.  ! Optimised for a 4 core machine
	NELMIN = 4       ! The minimum number of electronic optimisation steps
	NFREE  = 10      ! The size of DIIS space
	PREC   = Accurate
	LREAL  = .FALSE.
	ALGO   = Fast
	ISMEAR = -5      ! Smearing method 0=Gaussian, -5=tetrahedron (needs gamma and >2 kpoints)
	SIGMA  = 0.05    ! Width of smearing 
	EDIFF  = 1.0E-8
	EDIFFG = -5.0E-4
	LWAVE = .FALSE.
	LCHARGE = .FALSE.

### KPOINTS.supercell
I also create a KPOINTS.supercell file.  If phonopy uses a 2x2x2 supercell then we can reduce the number of kpoints in the calculation of the energy of the perturbed structures.  However for most situations where we have a large unit cell, there is no need to use a supercell in the phonopy calculation.  For the time being I will assume that we will do a 1x1x1 supercell calculation with Phonopy.  The KPOINTS.supercell is therefore the same as used for the VASP fixed-cell optimisation, but in the more general case of a non 1x1x1 supercell this may not be the case.

## Use Phonopy to create displaced coordinates
	phonopy -d --dim="1 1 1"

There should now be a list of POSCAR- files with the displaced coordinates in them.  For each POSCAR- file I create a DISP- directory and copy the POSCAR- file into it as POSCAR.  In addition I create a BORN-111 directory with the SPOSCAR file to calculate the permittivities and Born charges which are needed for the calculation of IR intensities.

## Create directories for VASP runs
We now create the directories we need.  I like to use a script to do this as it is very error prone otherwise, the following should do the job, no matter how many POSCAR- files there are.  First of all create a directory to perform the permittivity calculations (BORN-111), then copy into it the required files.  The loop over all the POSCAR- files and for each create an equivalent DISP- directory.  Then copy into then the required files.

	mkdir BORN-111
	cp SPOSCAR BORN-111/POSCAR
	cp POTCAR BORN-111/
    cp KPOINTS.supercell BORN-111/
    cp INCAR.born BORN-111/INCAR
	for f in POSCAR-*; do d=${f/POSCAR/DISP}; mkdir $d; cp $f $d/POSCAR; done
	for d in DISP-*; do cp INCAR.supercell $d/INCAR; cp KPOINTS.supercell $d/KPOINTS; cp POTCAR $d; done
	for d in BORN-111 DISP-*; do (cd $d; ln -s ../WAVECAR; ln -s ../CHG; ln -s ../CHGCAR); done

Now check a random DISP- directory to see everything is correct.  Check that the POSCAR file is the right one.  Compare it with the correct POSCAR- using diff.  Check that the INCAR has 'IBRION=-1' in it and that there is no NSW directive.  Check that the KPOINTS file is correct for the dimensions used in the Phonopy supercell calculation.

## Run the Vasp Jobs
All the DISP- jobs can be run using a relatively small cpu time.  They do not do any structural relaxation, just electronic relaxation.

	for d in DISP-* ; do (cd $d; runvasp $d 24 1); done

The calculation of the permittivity is a bigger job and should be run with a much longer cpu time.

	cd BORN-111
	runvasp born111 24 12

Once the calculation of the permittivities has completed I make a copy of the OUTCAR file in the parent directory;

	cp OUTCAR ../OUTCAR.born

## Assembling the Dynamical Matrix

Once the vasp jobs for displacements have completed, phonopy can be used to assemble the force sets and then the dynamical matrix can be calculated and stored.

	phonopy -f DISP-*/vasprun.xml
	phonopy --dim="1 1 1" --qpoints="0 0 0" --writedm
    grep frequency qpoints.yaml

When I tried doing this with the latest version of phonopy (v2.0) I got an error.  I reverted back to version 1.14.2 it seemed to work successfully. The frequencies in THz are reported by the grep command;

    frequency:   -0.0126133037
    frequency:   -0.0126133037
    frequency:   -0.0006182359
    frequency:    0.9952227159
    frequency:    1.0837744557
    frequency:    1.2860906754
    frequency:    1.2860906754
    frequency:    1.6771784765
    frequency:    1.6771784765
    frequency:    1.6798302431
    frequency:    2.0289949638
    frequency:    2.0289949638

These results are pretty close to the frequencies calculated using DFPT (see Dielec/ directory)

## Using PDGui
Once all the calculations have completed, the OUTCAR.born file has been created and the dynamical matrix, the infrared spectrum can be calculated;

	pdgui phonopy OUTCAR.born


## Warning for large data sets

If you have a large number of data sets I discovered that using the phonopy command to create the force sets failed to order the DISP- directories in the right order and I obtained many negative frequencies as a result. I notice that this is the problem with your aLM results.  POSCAR_1 should really be POSCAR_001 (and all of the others of course!  Similarly POSCAR_10 should be POSCAR_010.  Everything is then ordered correctly when you do

	phonopy -f DISP-*/vasprun.xml

To create the force sets the displacements will be in the right order.
To achieve this;

rename POSCAR_ POSCAR_0  POSCAR_??
rename POSCAR_ POSCAR_00 POSCAR_?

This has to be done with the rename command which is part of util-linux.  The order of the two commands above is important too!  Unfortunately, when I tried this on the aLM_phonopy directory it did not correct the problem.




