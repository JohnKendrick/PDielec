# Examples/Phonopy/Al2O3
# Phonopy calculation of Al2O3

| **Directory**  | **Description**                                               |
| -------------- | ------------------------------------------------------------- |
| Primitive_cell | Phonopy calculation using primitive cell                      |
| Standard_cell  | Phonopy calculation using standard cell                       |

[Back](..)


This example is based on the example/Al2O3 given in the Phonopy distribution.  There are some differences as the INCAR, KPOINTS and POTCAR files are not present in the distribution.

The purpose of the calculations is to show the different ways of calculating the vibrations using Phonopy's primitive cell and standard cell.  Also to compare the results with straightforward DFPT calculations.

```
Primitive_cell/        Directory with -pa Phonopy calculation on primitive cell
Standard_cell/         Directory with Phonopy calculation on standard cell
README.md              This file
```


## Optimise the geometry

The VASP geometry optimisation was performed.

The INCAR file for optimisation is;
```
PREC = accurate
ALGO = Normal
ADDGRID = T
NELMIN = 5
IBRION = 2
POTIM = 2
NSW = 50
EDIFF = 1E-8
EDIFFG = -1E-3
ENCUT = 500.00000000
LREAL = F
ISMEAR = 0
SIGMA = 0.01000000
GGA = PS
LMAXMIX = 4
```

The KPOINTS file is;
```
Regular k-point mesh
0
Monkhurst-Pack
3 3 1
0 0 0.5
```

The optimised POSCAR is;

```
generated by phonopy                    
   1.0000000000000000     
     4.7742263452989944    0.0000000000000000   -0.0000000000000000
    -2.3871131726494972    4.1346012984458653    0.0000000000000000
    -0.0000000000000000    0.0000000000000000   13.0113593913272219
   Al   O 
    12    18
Direct
  0.3333333333333357  0.6666666666666643  0.0187603745624614
  0.3333333333333357  0.6666666666666643  0.3145729587708743
  0.0000000000000000  0.0000000000000000  0.1479062921042100
  0.6666666666666643  0.3333333333333357  0.1854270412291257
  0.0000000000000000  0.0000000000000000  0.3520937078957900
  0.0000000000000000  0.0000000000000000  0.6479062921042100
  0.6666666666666643  0.3333333333333357  0.4812396254375386
  0.3333333333333357  0.6666666666666643  0.5187603745624614
  0.6666666666666643  0.3333333333333357  0.6854270412291257
  0.6666666666666643  0.3333333333333357  0.9812396254375386
  0.3333333333333357  0.6666666666666643  0.8145729587708743
  0.0000000000000000  0.0000000000000000  0.8520937078957900
  0.3058086537880129  0.0000000000000000  0.2500000000000000
  0.3608580128786514  0.3333333333333357  0.0833333333333357
  0.0000000000000000  0.3058086537880129  0.2500000000000000
  0.6666666666666643  0.0275246795453228  0.0833333333333357
  0.6941913462119871  0.6941913462119871  0.2500000000000000
  0.9724753204546772  0.6391419871213486  0.0833333333333357
  0.9724753204546772  0.3333333333333357  0.5833333333333357
  0.0275246795453228  0.6666666666666643  0.4166666666666643
  0.6666666666666643  0.6391419871213486  0.5833333333333357
  0.3333333333333357  0.3608580128786514  0.4166666666666643
  0.3608580128786514  0.0275246795453228  0.5833333333333357
  0.6391419871213486  0.9724753204546772  0.4166666666666643
  0.6391419871213486  0.6666666666666643  0.9166666666666643
  0.6941913462119871  0.0000000000000000  0.7500000000000000
  0.3333333333333357  0.9724753204546772  0.9166666666666643
  0.0000000000000000  0.6941913462119871  0.7500000000000000
  0.0275246795453228  0.3608580128786514  0.9166666666666643
  0.3058086537880129  0.3058086537880129  0.7500000000000000
```

# Standard Cell Calculations

## Calculate Born charges and Epsilon infinity

The optimised results (KPOINTS, INCAR, POSCAR, CONTCAR, POTCAR) are copied to the Standard_cell/Born/ directory
The Born calculation will be using the optimised geometry (make sure to copy CONTCAR to POSCAR)
Modify the INCAR and KPOINTS file (using double the k-point density for Born charges);

INCAR for a single point, with the calculation of epsilon infinity and Born charges(LEPSILON):
```
PREC = accurate
ALGO = Normal
ADDGRID = T
NELMIN = 5
    PREC = Accurate
  IBRION = -1
  NELMIN = 5
   ENCUT = 500
   EDIFF = 1.000000e-08
  ISMEAR = 0
   SIGMA = 1.000000e-02
   IALGO = 38
   LREAL = .FALSE.
   LWAVE = .FALSE.
  LCHARG = .FALSE.
LEPSILON = .TRUE.
LMAXMIX  = 4
GGA      = PS
```

KPOINTS:
```
Regular k-point mesh
0
Gamma
6 6 2
0 0 0.5
```

The symmetry unique charges are calculated using the Phonopy script "phonopy-vasp-born".
Later on these will be converted to PDielec format, which has all of the atoms in the file, not just the symmetry unique ones.

```
phonopy-vasp-born > BORN
```

## Prepare the Phonopy calculation

To begin with a calculation will be prepared which uses the standard cell.
Create the Standard_cell/ directory at the same level as the Born/ directory.
Copy the Standard_cell/Born/BORN charge file to the Standard_cell/ directory as well as KPOINTS, POSCAR, POTCAR 

Modify the INCAR file to do single point calculations with no storage of the charge density or the wavefunction:
```
    PREC = Accurate
    ALGO = Normal
  IBRION = -1
  NELMIN = 5
   ENCUT = 500
   EDIFF = 1.000000e-08
  ISMEAR = 0
   SIGMA = 1.000000e-02
   LREAL = .FALSE.
   LWAVE = .FALSE.
  LCHARG = .FALSE.
LMAXMIX  = 4
GGA      = PS
ADDGRID  = T
```

Since we will change the size of the cell, we can modify the KPOINTS file:
```
Regular k-point mesh
0
Monkhurst-Pack
2 2 1
0 0 0.5
```

Create a Standard_cell/SuperCell directory.
An unperturbed supercell calculation is performed to calculate the wavefunction and charge density.
The perturbed geometries are stored in POSCAR-??? files amd the supercell  in SPOSCAR.
The size of the supercell will be 2,2,1.  
Once the supercell POSCAR file has been created, links are made to POTCAR and KPOINTS in the SuperCell/ directory.
The INCAR file is copied as it will be edited to save the wavefunction and charge density files.

```
phonopy -d --dim 2 2 1 
mkdir SuperCell
cp SPOSCAR SuperCell/POSCAR
(cd SuperCell; cp ../INCAR .; ln -s ../POTCAR; ln -s ../KPOINTS) 
```

Edit the SuperCell/INCAR file so that the wavefunction and charge are saved.
The WAVECAR and CHGCAR files will restart the perturbed calculations.
After running the VASP job in SuperCell/.  Create links for the WAVECAR and CHGCAR files

```
ln -s SuperCell/WAVECAR; ln -s SuperCell/CHGCAR
```

Move the POSCAR-??? files for each displacement to a directory (POSCARS) where the calculations will be performed.
POTCAR, KPOINTS and INCAR files are the same for every calculation, so provide a link to the SuperCell files.
An advantage of using links for these files is that changes to the INCAR or KPOINTS files apply to all calculations.
WAVECAR and CHGCAR links need to be made in each of the perturbed geometry directories

```
mkdir POSCARS
for f in POSCAR-*
do
   mkdir POSCARS/$f
   cp $f POSCARS/$f/POSCAR
   ( cd POSCARS/$f; ln -s ../../INCAR; ln -s ../../POTCAR; ln -s ../../KPOINTS; ln -s ../../WAVECAR; ln -s ../../CHGCAR )
done
```

Submit all the jobs to a batch queue for processing.

```
cd POSCARS
for d in * 
do
(cd $d; runvasp $d 8 8 )
done
```

## Calculate the FORCES_SETS

```
phonopy -f POSCARS/POSCAR-{001..005}/vasprun.xml
```

## Calculate the Dynamical Matrix

The dynamical matrix is calculated in the standard basis, not the primitive.

```
phonopy --dim="2 2 1" --qpoints="0 0 0" --writedm
```

## Calculate the full set of Born charges

PDielec needs the Born charges for every atom, not just the symmetry unique ones.
The full set of charges is generated in file "PDIELEC_BORN" by the `phonopy-pdielec-born` command provided by PDielec.
Note that this command only uses the Phonopy library, no feature of the PDielec library is used.

```
phonopy-pdielec-born > BORN_PDIELEC
```

For comparison the BORN file for this calculation provided in the distribution of Phonopy is;
```
# epsilon and Z* of atoms 1 13
   3.27649624   -0.00000000    0.00000000   -0.00000000    3.27649624    0.00000000    0.00000000    0.00000000    3.21878866
   2.96008813   -0.02948662   -0.00000000    0.02948662    2.96008813   -0.00000000   -0.00000000    0.00000000    2.92614183
  -2.07328119    0.00000000    0.00000000   -0.00000000   -1.87350298    0.25811770   -0.00000000    0.35087130   -1.95076122
```

Whilst the BORN file calculated by the present calculation is;
```
# epsilon and Z* of atoms 1 13
   3.27607426   -0.00000000    0.00000000    0.00000000    3.27607426    0.00000000    0.00000000    0.00000000    3.23683513 
   2.95996414   -0.02948839   -0.00000000    0.02948839    2.95996414    0.00000000    0.00000000   -0.00000000    2.92951772 
  -2.07319123    0.00000000    0.00000000    0.00000000   -1.87342763    0.25818161    0.00000000    0.35167360   -1.95301181 
```

The agreement is accurate to 3 decimal places.

## PDGui

A pdgui calculation of the infrared intensities and the phonon frequencies is now possible.

```
pdgui phonopy.yaml
```

PDGui can be given any yaml file on the command line, the actual files read are always phonopy,yaml, qpoints.yaml and BORN_PDIELEC.

# Primitive Cell Phonopy Calculations

A primitive cell calculation of the dynamical matrix will be performed in the Primitive_cell directory.
Copy over files from the Standard_cell directory. 
```
cd Phonopy
cp BORN FORCE_SETS phonopy_disp.yaml phonopy.yaml ../Primitive_cell
```

The primitive cell has fewer atoms in it than the standard cell, so the BORN_PDIELEC file needs to be calculated again.
Before this the phonopy.yaml has to be updated with the primitive cell.  
This is carried out by a calculation of the dynamical matrix in the primitive basis.
After this the phonopy.yaml file should have the primitive cell and the BORN_PDIELEC file can be calculated.
It is important that the BORN_PDIELEC file is always updated after a change to phonopy.yaml.

```
phonopy --dim="2 2 1" --qpoints="0 0 0" --writedm --pa auto
phonopy-pdielec-born > BORN_PDIELEC
```

[Back](..)
