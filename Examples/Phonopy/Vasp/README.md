# VASP Phonopy Calculation of Urea

## Optimise the structure
The optimised structure will be found on CONTCAR

## Generate the directory and files
In the directory where the optimisation took place run the following script:

```
vasp_phonopy KPOINTS 1 1 1
```
If a larger supercell is going to be used then generate a file KPOINTS_phonopy with a reduced number of kpoints and run:

```
vasp_phonopy KPOINTS_phonopy 2 2 2
```

This will create sub-directory called Phonopy/ in which will be found everything needed to calculate the infrared spectrum using Phonopy.
In the Phonopy directory there should be:

1. Born.unitcell/ A directory where the Born charges and dielectric constants can be calculated for the perfect unitcell.  Be careful that the correct KPOINTS file is being used, it has to reflect the size of the unit-cell.
2. POSCAR/ A directory containing the perturned unit-cells.
3. DISPS/  A directory containing additional directories.
4. INCAR.born            - The INCAR to be used for the Born charge calculations
5. POSCAR.unitcell       - The POSCAR from the previous optimisation, can be used for the Born calculation
6. KPOINTS.unitcell      - The KPOINTS file used in the previous optimisation, can be used for the Born calculation
7. POTCAR.index.unitcell - The POTCAR index file used in the previous optimisation
8. INCAR.phonopy         - The INCAR to be used by Phonopy to calculate the energy of the perturbed structures
9. KPOINTS.phonopy       - The KPOINTS file to be used by Phonopy
10. POTCAR.index.phonopy - The POTCAR index file used for the Phonopy calculation of the perturbed structure energies
11. SPOSCAR              - The unperturbed supercell POSCAR file
12. phonopy_disp.yaml    - Phonopy output files
13. phonopy.yaml         - Phonopy output files


## Calculate the Born charges
The Born.unitcell/ directory can be used to calculate the Born charges independently of the force-constant (or dynamical) matrix.  The results are store in the vasprun.xml file.
This file should be copied into the Phonopy directory, where it will be used to provide both the Born charges and the optical permittivity at zero frequency.
The Born charges are calculated using phonopy-vasp-born and phonopy-pdielec-born commands.  
The first command comes from the Phonopy distribution and writes the Born charges as a symmetry unique list.
The second command is distributed with PDielec but it uses only Phonopy modules to create a file with a full list of all the atoms.

```
phonopy-vasp-born > BORN
phonopy-pdielec-born BORN_PDIELEC
```

## Calculate the dynamical matrix
In the Phonopy/DISPS directory submit each VASP job to calculate the energy and forces of the perturbed geometry.

```
for f in POSCAR-{0001..0016}:
  (cd $f; runvasp $f)
done
```

Once all the jobs have finished, create the FORCE_SETS file and the dynamical matrix at the gamma point.
```
phonopy  --vasp -f DISPS/POSCAR-{0001..0016}/vasprun.xml
phonopy --dim="1 1 1" --qpoints="0 0 0" --writedm
```

## Run pdgui
In addition to the files mentioned above there should now be some additional files in the Phonopy/ directory

14. FORCE_SETS     - The force sets file generated by Phonopy from the perturbed forces
15. qpoints.yaml   - A qpoints file containting the dynamical matrix
16. BORN           - The symmetry unique BORN charges
17. BORN_PDIELEC   - The full set of all BORN charges

pdgui can be run using the Phonopy output in qpoints.yaml, phonopy.yaml and BORN_PDIELEC.

```
pdgui qpoints.yaml
